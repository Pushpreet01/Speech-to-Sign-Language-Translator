{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center g-4">
    <!-- Convert card -->
    <div class="col-12 col-lg-7">
        <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">
                    <i class="fas fa-sign-language me-2"></i>
                    Convert to Sign Language
                </h4>
            </div>
            <div class="card-body">
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs mb-3" id="inputTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="record-tab" data-bs-toggle="tab"
                            data-bs-target="#record-input" type="button" role="tab">
                            <i class="fas fa-microphone me-2"></i>Live Recording
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="audio-tab" data-bs-toggle="tab" data-bs-target="#audio-input"
                            type="button" role="tab">
                            <i class="fas fa-upload me-2"></i>Audio Upload
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="text-tab" data-bs-toggle="tab" data-bs-target="#text-input"
                            type="button" role="tab">
                            <i class="fas fa-keyboard me-2"></i>Text Input
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="inputTabContent">
                    <!-- Live Recording Tab -->
                    <div class="tab-pane fade show active" id="record-input" role="tabpanel">
                        <div class="mb-3">
                            <label class="form-label">Record Live Audio</label>
                            <div class="text-center">
                                <div id="recordingStatus" class="alert alert-info">
                                    <i class="fas fa-microphone me-2"></i>
                                    Click "Start Recording" to begin
                                </div>

                                <div class="mb-3">
                                    <button type="button" id="startRecordBtn" class="btn btn-danger btn-lg me-2">
                                        <i class="fas fa-microphone me-2"></i>
                                        Start Recording
                                    </button>
                                    <button type="button" id="stopRecordBtn" class="btn btn-secondary btn-lg" disabled>
                                        <i class="fas fa-stop me-2"></i>
                                        Stop Recording
                                    </button>
                                </div>

                                <div id="recordingTimer" class="h4 text-muted mb-3" style="display: none;">
                                    00:00
                                </div>

                                <div id="audioPreview" class="mb-3" style="display: none;">
                                    <audio id="recordedAudio" controls class="w-100"></audio>
                                    <div class="mt-2">
                                        <button type="button" id="processRecordedBtn" class="btn btn-success">
                                            <i class="fas fa-sign-language me-2"></i>
                                            Convert to Signs
                                        </button>
                                        <button type="button" id="recordAgainBtn"
                                            class="btn btn-outline-secondary ms-2">
                                            <i class="fas fa-redo me-2"></i>
                                            Record Again
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Audio Upload Tab -->
                    <div class="tab-pane fade" id="audio-input" role="tabpanel">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="audio_file" class="form-label">Choose Audio File</label>
                                <input type="file" class="form-control" id="audio_file" name="audio_file"
                                    accept=".wav,.mp3,.mp4,.m4a,.flac,.webm,.ogg" required>
                                <div class="form-text">
                                    Supported formats: WAV, MP3, MP4, M4A, FLAC, WebM, OGG (Max: 16MB)
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-upload me-2"></i>
                                Convert Audio to Signs
                            </button>
                        </form>
                    </div>

                    <!-- Text Input Tab -->
                    <div class="tab-pane fade" id="text-input" role="tabpanel">
                        <form id="textForm">
                            <div class="mb-3">
                                <label for="text_input" class="form-label">Enter Text to Convert</label>
                                <textarea class="form-control" id="text_input" name="text_input" rows="3"
                                    placeholder="Type your message here... (e.g., 'hello good morning thank you')"
                                    required></textarea>
                                <div class="form-text">
                                    Try phrases like: "hello world", "good morning", "thank you very much", "how are
                                    you"
                                </div>
                            </div>

                            <!-- Quick Examples -->
                            <div class="mb-3">
                                <label class="form-label">Quick Examples (click to try):</label>
                                <div class="d-flex flex-wrap gap-2">
                                    <button type="button" class="btn btn-outline-secondary btn-sm example-btn"
                                        data-text="hello world thank you">Hello World</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm example-btn"
                                        data-text="good morning how are you">Good Morning</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm example-btn"
                                        data-text="thank you very much">Thank You</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm example-btn"
                                        data-text="nice to meet you">Nice to Meet You</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm example-btn"
                                        data-text="please help me">Help Request</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm example-btn"
                                        data-text="have a nice day">Have a Nice Day</button>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-sign-language me-2"></i>
                                Convert Text to Signs
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Progress section -->
                <div id="progressSection" class="mt-4" style="display: none;">
                    <div class="progress mb-3">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                            role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="statusMessage" class="text-center">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        Uploading file...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- How it works card -->
    <div class="col-12 col-lg-5">
        <div class="card shadow h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    How it works
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        <h6><i class="fas fa-keyboard me-2 text-success"></i>Text Input</h6>
                        <ol>
                            <li>Type or select example text</li>
                            <li>Click "Convert Text to Signs"</li>
                            <li>View instant sign language results</li>
                        </ol>
                    </div>
                    <div class="col-12">
                        <h6><i class="fas fa-microphone me-2 text-danger"></i>Live Recording</h6>
                        <ol>
                            <li>Click "Start Recording"</li>
                            <li>Speak into your microphone</li>
                            <li>Click "Stop Recording" when done</li>
                            <li>Preview and convert to signs</li>
                        </ol>
                    </div>
                    <div class="col-12">
                        <h6><i class="fas fa-upload me-2 text-primary"></i>Audio Upload</h6>
                        <ol>
                            <li>Upload an audio file</li>
                            <li>AI converts speech to text</li>
                            <li>Text mapped to sign language</li>
                            <li>View the sign sequence</li>
                        </ol>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-globe me-1"></i>
                        Real British Sign Language videos from SignBSL.com when available
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Handle example button clicks
    document.querySelectorAll('.example-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const text = this.getAttribute('data-text');
            document.getElementById('text_input').value = text;

            // Optional: Auto-submit the form
            // document.getElementById('textForm').dispatchEvent(new Event('submit'));
        });
    });

    // Handle text form submission
    document.getElementById('textForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const textInput = document.getElementById('text_input');
        const text = textInput.value.trim();

        if (!text) {
            alert('Please enter some text');
            return;
        }

        // Show progress
        const progressSection = document.getElementById('progressSection');
        const progressBar = document.getElementById('progressBar');
        const statusMessage = document.getElementById('statusMessage');

        progressSection.style.display = 'block';
        progressBar.style.width = '30%';
        statusMessage.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing text...';

        try {
            const response = await fetch('/process_text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: text })
            });

            const result = await response.json();

            if (result.success) {
                progressBar.style.width = '100%';
                progressBar.classList.remove('progress-bar-animated');
                statusMessage.innerHTML = '<i class="fas fa-check me-2"></i>Processing complete! Redirecting...';

                setTimeout(() => {
                    window.location.href = `/results/${result.job_id}`;
                }, 1000);
            } else {
                progressSection.style.display = 'none';
                alert('Processing failed: ' + result.message);
            }
        } catch (error) {
            progressSection.style.display = 'none';
            alert('Processing failed: ' + error.message);
        }
    });

    // Handle audio form submission
    document.getElementById('uploadForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData();
        const fileInput = document.getElementById('audio_file');
        const file = fileInput.files[0];

        if (!file) {
            alert('Please select a file');
            return;
        }

        formData.append('audio_file', file);

        // Show progress
        const progressSection = document.getElementById('progressSection');
        const progressBar = document.getElementById('progressBar');
        const statusMessage = document.getElementById('statusMessage');

        progressSection.style.display = 'block';
        progressBar.style.width = '30%';
        statusMessage.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading file...';

        try {
            const response = await fetch('/upload?wait=1', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                // If server waited and it's ready, redirect immediately
                if (result.ready && result.redirect_url) {
                    progressBar.style.width = '100%';
                    progressBar.classList.remove('progress-bar-animated');
                    statusMessage.innerHTML = '<i class="fas fa-check me-2"></i>Processing complete! Redirecting...';
                    setTimeout(() => {
                        window.location.href = result.redirect_url;
                    }, 800);
                } else {
                    // Fall back to client-side polling
                    progressBar.style.width = '60%';
                    statusMessage.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing audio...';
                    const jobId = result.job_id;
                    pollStatus(jobId);
                }
            } else {
                progressSection.style.display = 'none';
                alert('Upload failed: ' + result.message);
            }
        } catch (error) {
            progressSection.style.display = 'none';
            alert('Upload failed: ' + error.message);
        }
    });

    async function pollStatus(jobId) {
        const progressBar = document.getElementById('progressBar');
        const statusMessage = document.getElementById('statusMessage');

        try {
            const response = await fetch(`/status/${jobId}`);
            const result = await response.json();

            if (result.status === 'completed') {
                progressBar.style.width = '100%';
                progressBar.classList.remove('progress-bar-animated');
                statusMessage.innerHTML = '<i class="fas fa-check me-2"></i>Processing complete! Redirecting...';

                setTimeout(() => {
                    window.location.href = `/results/${jobId}`;
                }, 1500);
            } else if (result.status === 'processing') {
                progressBar.style.width = '80%';
                statusMessage.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>' + result.message;

                // Poll again in 2 seconds
                setTimeout(() => pollStatus(jobId), 2000);
            } else {
                progressSection.style.display = 'none';
                alert('Processing failed: ' + result.message);
            }
        } catch (error) {
            progressSection.style.display = 'none';
            alert('Error checking status: ' + error.message);
        }
    }

    // Live Recording Functionality
    let mediaRecorder;
    let audioChunks = [];
    let recordingTimer;
    let recordingStartTime;

    // Check if browser supports recording
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        document.getElementById('recordingStatus').innerHTML =
            '<i class="fas fa-exclamation-triangle me-2"></i>Recording not supported in this browser';
        document.getElementById('startRecordBtn').disabled = true;
    }

    // Start recording
    document.getElementById('startRecordBtn').addEventListener('click', async function () {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

            // Try different supported MIME types in order of preference
            const mimeTypes = [
                'audio/webm;codecs=opus',
                'audio/webm',
                'audio/mp4',
                'audio/ogg;codecs=opus',
                'audio/ogg'
            ];

            let selectedMimeType = null;
            for (const mimeType of mimeTypes) {
                if (MediaRecorder.isTypeSupported(mimeType)) {
                    selectedMimeType = mimeType;
                    break;
                }
            }

            if (!selectedMimeType) {
                throw new Error('No supported audio recording format found');
            }

            mediaRecorder = new MediaRecorder(stream, {
                mimeType: selectedMimeType
            });

            audioChunks = [];
            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: selectedMimeType });
                const audioUrl = URL.createObjectURL(audioBlob);
                document.getElementById('recordedAudio').src = audioUrl;
                document.getElementById('audioPreview').style.display = 'block';
                document.getElementById('recordingStatus').innerHTML =
                    '<i class="fas fa-check me-2"></i>Recording completed! Preview your audio below.';
            };

            mediaRecorder.start();
            recordingStartTime = Date.now();
            startRecordingTimer();

            document.getElementById('startRecordBtn').disabled = true;
            document.getElementById('stopRecordBtn').disabled = false;
            document.getElementById('recordingStatus').innerHTML =
                '<i class="fas fa-microphone me-2"></i>Recording... Click "Stop Recording" when done.';
            document.getElementById('recordingTimer').style.display = 'block';
            document.getElementById('audioPreview').style.display = 'none';
        } catch (error) {
            alert('Error accessing microphone: ' + error.message);
        }
    });

    // Stop recording
    document.getElementById('stopRecordBtn').addEventListener('click', function () {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());

            document.getElementById('startRecordBtn').disabled = false;
            document.getElementById('stopRecordBtn').disabled = true;
            document.getElementById('recordingTimer').style.display = 'none';

            clearInterval(recordingTimer);
        }
    });

    // Record again
    document.getElementById('recordAgainBtn').addEventListener('click', function () {
        document.getElementById('audioPreview').style.display = 'none';
        document.getElementById('recordingStatus').innerHTML =
            '<i class="fas fa-microphone me-2"></i>Click "Start Recording" to begin';
    });

    // Process recorded audio
    document.getElementById('processRecordedBtn').addEventListener('click', async function () {
        // Determine file extension based on MIME type
        let fileExtension = 'webm';
        if (mediaRecorder && mediaRecorder.mimeType) {
            if (mediaRecorder.mimeType.includes('mp4')) {
                fileExtension = 'mp4';
            } else if (mediaRecorder.mimeType.includes('ogg')) {
                fileExtension = 'ogg';
            }
        }

        const audioBlob = new Blob(audioChunks, { type: mediaRecorder ? mediaRecorder.mimeType : 'audio/webm' });

        // Show progress
        const progressSection = document.getElementById('progressSection');
        const progressBar = document.getElementById('progressBar');
        const statusMessage = document.getElementById('statusMessage');

        progressSection.style.display = 'block';
        progressBar.style.width = '30%';
        statusMessage.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading recorded audio...';

        try {
            const formData = new FormData();
            formData.append('audio_file', audioBlob, `recording.${fileExtension}`);

            const response = await fetch('/upload?wait=1', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                if (result.ready && result.redirect_url) {
                    progressBar.style.width = '100%';
                    progressBar.classList.remove('progress-bar-animated');
                    statusMessage.innerHTML = '<i class="fas fa-check me-2"></i>Processing complete! Redirecting...';
                    setTimeout(() => {
                        window.location.href = result.redirect_url;
                    }, 800);
                } else {
                    progressBar.style.width = '60%';
                    statusMessage.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing audio...';
                    const jobId = result.job_id;
                    pollStatus(jobId);
                }
            } else {
                progressSection.style.display = 'none';
                alert('Upload failed: ' + result.message);
            }
        } catch (error) {
            progressSection.style.display = 'none';
            alert('Upload failed: ' + error.message);
        }
    });

    function startRecordingTimer() {
        recordingTimer = setInterval(() => {
            const elapsed = Date.now() - recordingStartTime;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const displaySeconds = seconds % 60;
            document.getElementById('recordingTimer').textContent =
                `${minutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
        }, 1000);
    }
</script>
{% endblock %}